#!/bin/bash

# dependencies #

source /data/data/com.termux/files/usr/bin/console
source /data/data/com.termux/files/usr/bin/globals

# script #

script=$(basename -- "${BASH_SOURCE[0]}")

# version #

version="08-12-2021"

# usage #

while (($#))
do
	case "${1}" in
		 -h|--help)
			echo
			echo -e "Usage: ${script} [OPTION]"
			echo
			echo -e "Options:"
			echo
			echo -e "-h, --help \t Show help and usage information."
			echo
			echo -e "'${script}' [ Version ${version} ]"
			echo

			exit
		;;

		*)
			echo
			echo "Usage: ${script} [OPTION]"
			echo
			echo -e "${script}: Unknown option '${1}'"
			echo -e "Type './${script} --help' for help and usage information."
			echo

			exit 1
		;;
	esac

	shift
done

# variables #

console.inf "Updating Termux Packages."
echo

# prompt #

console.err "Termux is no longer being updated in the Google Play store:"
console.err "A recent Google Play Store policy forcing all applications to update"
console.err "to SDK 29 has made Termux incomaptible with latest Play Store guidelines."
console.err "Updates have not been published since November 2020 for that release."
echo

console.inf "This utility fetches the Termux APK from the F-Droid repository"
console.inf "and installs it for you:"
echo

console.wrn "This process only functions only if you've previously backed up/uninstalled"
console.wrn "the Google Play Store version of the application."
echo

console.inf "If you have not already done so, please visit the following wiki pages"
console.inf "on how to proceed:"
echo

console.inf "Backing up Termux : https://wiki.termux.com/wiki/Backing_up_Termux"
console.inf "Installing Termux: https://wiki.termux.com/wiki/installation"
echo

console.usr "Update Termux?"
echo

read reply
echo

if [[ "${reply}" = [yY] ]] || [[ "${reply}" = [yY][eE][sS] ]]
then
	# packages #
	
	packages_list=(
		com.termux
		com.termux.api
		)
	
	# variables #
	
	for package in ${packages_list[@]}
	do
		archive=$(curl -sL https://f-droid.org/en/packages/"${package}" | grep -o "${package}"[aA0-zZ9-_]*.apk | head -n 1)
		
		archive_url="https://f-droid.org/repo/${archive}"
		
		# download
		
		console.fwd "Dowloading update [ termux ]..."
		echo
		
		console.download "${archive_url}" "${PWD}" "${archive}"
		
		# update
		
		xdg-open "${archive}"
	done
else
	# continue without update
	
	console.err "Proceeding without update."
	console.wrn "Setup process may encounter errors:"
	echo
	
	console.inf "Follow wiki pages stated above to correct issues"
	console.inf "and restart setup process on a fresh Termux installation."
	echo
fi