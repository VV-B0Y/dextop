#!/bin/bash

# dependencies #

source /data/data/com.termux/files/usr/bin/console
source /data/data/com.termux/files/usr/bin/globals

# script #

script=$(basename -- "${BASH_SOURCE[0]}")

# version #

version="08-12-2021"

# usage #

while (($#))
do
	case "${1}" in
		 -h|--help)
			echo
			echo -e "Usage: ${script} [OPTION]"
			echo
			echo -e "Options:"
			echo
			echo -e "-h, --help \t Show help and usage information."
			echo
			echo -e "'${script}' [ Version ${version} ]"
			echo

			exit
		;;

		*)
			echo
			echo "Usage: ${script} [OPTION]"
			echo
			echo -e "${script}: Unknown option '${1}'"
			echo -e "Type './${script} --help' for help and usage information."
			echo

			exit 1
		;;
	esac

	shift
done

# prompt #


console.inf "Updating packages [ termux ]."
echo

# variables #

packages_url="https://f-droid.org/en/packages"
repository_url="https://f-droid.org/repo"

# packages #

packages_list=(
	com.termux
	com.termux.api
	)

# message #

console.err "Termux packages are no longer being updated in the Google Play Store:"
console.err "A recent Google Play Store policy forcing all applications to update"
console.err "to SDK 29 has made TeStor packages incomaptible with latest Play Store"
console.err "guidelines, halting updates since November 2020 for that release."
echo

console.wrn "This utility fetches the Termux/API APKs from the F-Droid repository"
console.wrn "and installs them for you:"
echo

console.wrn "This process only functions if you've previously backed up/uninstalled"
console.wrn "the Google Play Store version of those APKs."
echo

console.inf "If you have not already done so, please visit the following wiki pages:"
echo

console.inf "Backing up Termux: https://wiki.termux.com/wiki/Backing_up_Termux"
console.inf "Installing Termux: https://wiki.termux.com/wiki/installation"
echo

console.usr "Select 'Package Installer' when prompted"
console.usr "to install the APK updates."
echo

console.countdown "Prompt in:" 10
echo

# request update permission

console.ipt "Update Termux packages?"
echo

read reply
echo

# process update

if [[ "${reply}" = [yY] ]] || [[ "${reply}" = [yY][eE][sS] ]]
then
		console.fwd "Dowloading updates [ termux ]..."
		echo

	for package in ${packages_list[@]}
	do
		archive=$(curl -sL "${packages_url}"/"${package}" | grep -o "${package}"[aA0-zZ9-_]*.apk | head -n 1)
		
		archive_url="${repository_url}/${archive}"
		
		# download
		
		console.download "${repository_url}" "${PWD}" ${archive}
		
		# update
		
		xdg-open "${archive}"
	done
else
	# continue without update
	
	console.err "Proceeding without update."
	console.wrn "Setup process may encounter errors:"
	echo
	
	console.inf "Follow wiki pages stated above to correct issues."
	console.inf "Restart setup process on a fresh Termux installation to proceed."
	echo
	
	console.wait 2
fi